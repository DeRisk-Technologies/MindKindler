# MindKindler "Country OS" Handover Report (V2)

**Project Status:** Pilot Ready (UK Region Verified)

MindKindler has successfully transitioned from a single-tenant prototype to a **Global Multi-Region SaaS** ("Country OS"). It features strict Data Sovereignty, Role-Based Access Control (RBAC), and Statutory Compliance (UK EYFS 2025).

---

## 1. Core Architecture (The "Federated" Model)

The application uses a **Split-Brain Database Architecture** to ensure PII never leaves its legal jurisdiction.

*   **Global Control Plane (`default` DB):**
    *   **User Routing:** `user_routing/{uid}` maps users to their region (`uk`, `us`).
    *   **Organizations:** `organizations/{tenantId}` stores tenant metadata and subscription info.
    *   **Marketplace:** Stores installable Country Packs (`uk_la_pack.json`).
*   **Regional Data Plane (Shards):**
    *   `mindkindler-uk`, `mindkindler-us`, `mindkindler-eu`.
    *   Stores **ALL PII**: `users` (Profiles), `students` (Clinical Records), `cases` (Interventions), `reports`.
*   **Logic Layer:**
    *   **Hooks:** `usePermissions` and `useFirestore` are "Shard-Aware". They check the Global Router first, then connect to the specific Regional DB instance.
    *   **Services:** `Student360Service` and `StaffService` explicitly write to the regional shard identified by the user's session.

---

## 2. Completed Accomplishments

### A. Independent Practitioner Workflow (Latest)
*   **Auto-Tenancy:** Independent EPPs (e.g., "Helena5") can sign up and immediately get a dedicated Tenant (`helena5-psched-ltd-uk`) created in the Global DB.
*   **Practice Console:** Created `/dashboard/practice/schools` and `/dashboard/practice/team` for EPPs to manage their own client base, separate from the SuperAdmin console.
*   **Role Normalization:** `educationalpsychologist` role maps correctly to `EPP` permissions, unlocking the Clinical Menu group.

### B. Security & Trust Engine
*   **Verified Rules:** Deployed robust `firestore.rules` to Regional Shards (`mindkindler-uk`) allowing:
    *   Users to write their own profiles (Self-Registration).
    *   EPPs to create Schools and Students within their shard.
    *   Recursive access to subcollections (`students/{id}/family_members`).
*   **Verification Queue:** Admins can approve EPPs. Logic now preserves the HCPC number entered during signup.
*   **Single Central Record (SCR):** Filtered to show only *School Staff* (Teachers), excluding external EPPs to prevent data leakage.

### C. Pilot Tooling
*   **Seed Script:** `seedDemoData` cloud function now supports `action: 'create_regional_admins'`, generating login-ready SuperAdmins for UK, US, EU (`admin_uk@mindkindler.com`).
*   **Data Isolation:** Admin Console (`Global Users`) now includes a **Tenant Selector**, allowing "Lost" users to be manually assigned to a workspace.

---

## 3. Current Challenges & Solutions

*   **Rule Synchronization:** We are manually copying `firestore.rules` to `mindkindler-uk`.
    *   *Solution:* Use `firebase deploy --only firestore:rules` with specific targets in `firebase.json` for automated sync.
*   **Race Conditions:** Signing up creates Auth immediately, but Firestore Profile creation (in shard) depends on network/rules.
    *   *Solution:* We implemented the "Dual-Write" logic in `signup/page.tsx` and the "Fix Permissions" dev tool in the Dashboard to recover any desynced users.

---

## 4. Important Files & Locations

*   **Routing Logic:** `src/hooks/use-permissions.ts` (The brain that connects to the correct DB).
*   **Signup Logic:** `src/app/signup/page.tsx` (Handles Global Routing + Regional Profile + Tenant Creation).
*   **Clinical Services:** `src/services/student360-service.ts` (Writes PII to Regional DB).
*   **Security:** `firestore.rules` (The master ruleset, applied to all shards).
*   **Compliance Data:** `src/marketplace/catalog/uk_la_pack.json` (Defines UPN, DBS fields).

---

## 5. Next Steps (Immediate)

1.  **US Pilot Setup:**
    *   Run `seedDemoData` to create `admin_us`.
    *   Copy `firestore.rules` to `mindkindler-us` database.
    *   Verify US Signup flow (State ID instead of UPN).
2.  **Mobile App:** Verify the `/dashboard/assessments/mobile` route on an actual iPad.
3.  **Chat:** Activate the `ChatService` logic (currently client-side) to use the Regional DB for message storage.
4.  **Comprehensive EPP Workflow Testing:**
    *   **Full Feature Audit:** Test Consultation, Assessment, Report, Messaging, Calendar & Booking, Data Ingestion, and Community (Wiki/Blog/Forum) as an Independent EPP.
    *   **Data Verification:** Ensure absolutely all data generated by these features lands in the Regional Firestore DB, not the default one.
5.  **Hierarchy & Form Enhancements (User Feedback):**
    *   **LEA Support:** Allow EPPs to create LEAs (Local Education Authorities) as top-level clients, and then create Schools *under* those LEAs.
    *   **School Visibility Bug:** Fix issue where schools created by an EPP in `mindkindler-uk` are not visible in the Student Creation dropdown.
    *   **Detailed School Form:** Expand School creation to include: Principal Officers, District/LEA linkage, Credentials, Registration Numbers, etc.
    *   **Detailed Staff Form:** Enable EPPs to create Staff/Teachers for their schools with comprehensive detail fields.

**Ready for Handoff.** Paste this report into the new session to resume seamlessly.
