rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getRole() {
      return request.auth.token.role;
    }

    function getTenantId() {
      return request.auth.token.tenantId;
    }

    function isSystemAdmin() {
      let role = getRole();
      return isAuthenticated() && (
        role == 'SuperAdmin' || role == 'Admin' || role == 'admin' || role == 'superadmin'
      );
    }

    function isTenantMember(tenantId) {
      return isAuthenticated() && (getTenantId() == tenantId || isSystemAdmin());
    }
    
    function isClinician(tenantId) {
       let role = getRole();
       return isTenantMember(tenantId) && (
         role in [
            'EPP', 'epp', 'EducationalPsychologist', 'educationalpsychologist', 
            'ClinicalPsychologist', 'clinicalpsychologist', 'SchoolPsychologist', 
            'TenantAdmin', 'SuperAdmin', 'Admin', 'SchoolAdministrator', 'admin', 'tenantadmin'
         ]
       );
    }

    // --- Global Settings & Translations ---
    match /organization_settings/{id} {
      allow read: if true; 
      allow write: if isSystemAdmin();
    }

    match /translations/{document=**} {
      allow read: if true;
      allow write: if isSystemAdmin();
    }

    // --- Core User Management ---
    match /users/{userId} {
      allow read: if isAuthenticated(); 
      allow write: if isSystemAdmin() || request.auth.uid == userId;
    }

    // --- Enterprise & GovIntel ---
    match /organizations/{orgId} {
      allow read: if isAuthenticated(); 
      allow create: if isSystemAdmin();
      allow update: if isSystemAdmin() || (isAuthenticated() && getTenantId() == orgId);
    }

    // --- Tenant Data (Multi-DB / Shards) ---
    match /tenants/{tenantId} {
      // FIX: Base tenant read access
      allow read: if isTenantMember(tenantId);
      
      // FIX: Deep mapping for settings and i18n
      match /settings/{document=**} {
        allow read: if isTenantMember(tenantId);
        allow write: if isTenantMember(tenantId);
      }
      
      match /i18n/{document=**} {
        allow read: if isTenantMember(tenantId);
        allow write: if isTenantMember(tenantId);
      }

      match /students/{studentId} {
        allow read: if isTenantMember(tenantId);
        allow write: if isClinician(tenantId);
        match /{sub=**} {
          allow read: if isTenantMember(tenantId);
          allow write: if isClinician(tenantId);
        }
      }

      match /cases/{caseId} {
        allow read: if isTenantMember(tenantId);
        allow write: if isClinician(tenantId);
        match /{sub=**} {
          allow read: if isTenantMember(tenantId);
          allow write: if isClinician(tenantId);
        }
      }

      match /consultations/{docId} {
        allow read: if isTenantMember(tenantId);
        allow write: if isClinician(tenantId);
      }

      match /appointments/{appointmentId} {
        allow read, write: if isTenantMember(tenantId);
      }
      
      match /chats/{chatId} {
        allow read, update: if isTenantMember(tenantId);
        allow create: if isTenantMember(tenantId);
        match /messages/{msgId} {
           allow read, create: if isTenantMember(tenantId);
        }
      }
      
      match /community/{document=**} {
        allow read: if isTenantMember(tenantId);
        allow write: if isTenantMember(tenantId);
      }
    }

    match /policyRules/{ruleId} { allow read: if isAuthenticated(); allow write: if isSystemAdmin(); }
    match /guardianFindings/{fId} { allow read, create, update: if isAuthenticated(); }

    // --- Default Deny ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
