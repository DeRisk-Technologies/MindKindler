rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getRole() {
      return request.auth.token.role;
    }

    function getTenantId() {
      return request.auth.token.tenantId;
    }

    function isSystemAdmin() {
      let role = getRole();
      return isAuthenticated() && (
        role == 'SuperAdmin' || role == 'Admin' || role == 'admin' || role == 'superadmin'
      );
    }

    function isTenantMember(tenantId) {
      return isAuthenticated() && (getTenantId() == tenantId || isSystemAdmin());
    }
    
    function isClinician(tenantId) {
       let role = getRole();
       return isTenantMember(tenantId) && (
         role != null && (
           role.lower() in [
              'epp', 'educationalpsychologist', 'clinicalpsychologist', 
              'schoolpsychologist', 'tenantadmin', 'superadmin', 'admin', 'schooladministrator'
           ]
         )
       );
    }

    // --- Global Settings (Fixes Landing Page Error) ---
    match /organization_settings/{id} {
      allow read: if true; // Publicly readable for landing page
      allow write: if isSystemAdmin();
    }

    // --- Core User Management ---
    match /users/{userId} {
      allow read: if isAuthenticated(); 
      allow write: if isSystemAdmin() || request.auth.uid == userId;
    }

    // --- Enterprise & GovIntel ---
    match /organizations/{orgId} {
      allow read: if isAuthenticated(); 
      allow create: if isSystemAdmin();
      allow update: if isSystemAdmin() || (isAuthenticated() && getTenantId() == orgId);
    }

    // --- Student 360 & Clinical Data ---
    match /tenants/{tenantId}/students/{studentId} {
      allow read: if isTenantMember(tenantId);
      allow write: if isClinician(tenantId);
      
      match /{allSubcollections=**} {
        allow read: if isTenantMember(tenantId);
        allow write: if isClinician(tenantId);
      }
    }
    
    match /tenants/{tenantId}/cases/{caseId} {
       allow read: if isTenantMember(tenantId);
       allow write: if isClinician(tenantId);
       
       match /{allSubcollections=**} {
          allow read: if isTenantMember(tenantId);
          allow write: if isClinician(tenantId);
       }
    }

    match /tenants/{tenantId}/consultations/{docId} {
       allow read: if isTenantMember(tenantId);
       allow write: if isClinician(tenantId);
    }

    // --- Calendar & Messaging ---
    match /tenants/{tenantId}/appointments/{appointmentId} {
      allow read, write: if isTenantMember(tenantId);
    }
    
    match /tenants/{tenantId}/chats/{chatId} {
      allow read, update: if isTenantMember(tenantId);
      allow create: if isTenantMember(tenantId);
      
      match /messages/{msgId} {
         allow read, create: if isTenantMember(tenantId);
      }
    }

    match /policyRules/{ruleId} { allow read: if isAuthenticated(); allow write: if isSystemAdmin(); }
    match /guardianFindings/{fId} { allow read, create, update: if isAuthenticated(); }

    // --- Default Deny ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
