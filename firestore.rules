rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    function isParticipant(resource) {
       return request.auth.uid in resource.data.participantIds;
    }
    function isOwner(resource) {
       return request.auth.uid == resource.data.userId;
    }

    // Students Collection (Secure)
    match /students/{studentId} {
      allow read: if false; // Block direct reads! Use Cloud Function.
      allow write: if isAuthenticated() && (request.auth.token.role == 'EPP' || request.auth.token.role == 'SchoolAdmin');
      
      match /family_members/{memberId} {
        allow read: if false;
        allow write: if isAuthenticated();
      }
      match /verification_tasks/{taskId} {
         allow read, write: if isAuthenticated();
      }
    }

    // Secure Messaging (Sprint 5)
    match /chats/{chatId} {
      // Only participants can read/write to the channel
      allow read: if isAuthenticated() && isParticipant(resource);
      allow create: if isAuthenticated(); // Validation needed on create content
      allow update: if isAuthenticated() && isParticipant(resource);
      
      match /messages/{msgId} {
        allow read: if isAuthenticated() && 
          exists(/databases/$(database)/documents/chats/$(chatId)) && 
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds;
          
        allow create: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds;
      }
    }

    // AI Copilot Sessions (Sprint 6)
    match /bot_sessions/{sessionId} {
      allow read, write: if isAuthenticated() && isOwner(resource);
      
      match /messages/{msgId} {
         allow read: if isAuthenticated() && isOwner(get(/databases/$(database)/documents/bot_sessions/$(sessionId)));
         allow write: if false; // Only Cloud Function writes messages here
      }
    }
    
    // Appointments (Sprint 4)
    match /appointments/{apptId} {
       allow read: if isAuthenticated() && (
          resource.data.hostUserId == request.auth.uid || 
          request.auth.uid in resource.data.participantIds
       );
       allow create: if isAuthenticated();
       allow update: if isAuthenticated() && resource.data.hostUserId == request.auth.uid;
    }
    
    match /availability_slots/{slotId} {
       allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Document Staging
    match /document_staging/{docId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated() && resource.data.tenantId == request.auth.token.tenantId;
      allow update: if isAuthenticated();
    }
    
    // Default Block
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
