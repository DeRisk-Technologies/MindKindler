rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // SHARDING-SAFE ROLE CHECK
    // Prioritizes token claims (Role-based access across shards)
    function getRole() {
      return request.auth.token.role;
    }

    function getTenantId() {
      return request.auth.token.tenantId;
    }

    function isSystemAdmin() {
      let role = getRole();
      return isAuthenticated() && (role == 'SuperAdmin' || role == 'Admin' || role == 'admin' || role == 'superadmin');
    }

    function isTenantMember(tenantId) {
      return isAuthenticated() && (getTenantId() == tenantId || isSystemAdmin());
    }
    
    function isClinician(tenantId) {
       let role = getRole();
       let normalizedRole = role.lower(); // Rules v2 support string methods
       return isTenantMember(tenantId) && 
         (normalizedRole in [
            'epp', 'educationalpsychologist', 'clinicalpsychologist', 
            'schoolpsychologist', 'tenantadmin', 'superadmin', 'admin'
         ]);
    }

    // --- Core User Management ---
    match /users/{userId} {
      allow read: if isAuthenticated(); 
      allow write: if isSystemAdmin() || request.auth.uid == userId;
    }

    // --- Enterprise & GovIntel ---
    match /organizations/{orgId} {
      allow read: if isAuthenticated(); 
      allow create: if isSystemAdmin();
      allow update: if isSystemAdmin() || (isAuthenticated() && getTenantId() == orgId);
    }

    // --- Student 360 & Clinical Data ---
    // This now works across ALL sharded regional databases
    match /tenants/{tenantId}/students/{studentId} {
      allow read: if isTenantMember(tenantId);
      allow write: if isClinician(tenantId);
      
      match /{allSubcollections=**} {
        allow read, write: if isClinician(tenantId);
      }
    }
    
    match /tenants/{tenantId}/cases/{caseId} {
       allow read: if isTenantMember(tenantId);
       allow write: if isClinician(tenantId);
       
       match /{allSubcollections=**} {
          allow read, write: if isClinician(tenantId);
       }
    }

    match /tenants/{tenantId}/consultations/{docId} {
       allow read, write: if isClinician(tenantId);
    }

    // --- Other Collections ---
    match /tenants/{tenantId}/appointments/{appointmentId} {
      allow read: if isTenantMember(tenantId);
      allow write: if isTenantMember(tenantId);
    }
    
    match /tenants/{tenantId}/chats/{chatId} {
      allow read, update: if isTenantMember(tenantId) && request.auth.uid in resource.data.participantIds;
      allow create: if isTenantMember(tenantId);
      
      match /messages/{msgId} {
         allow read: if isTenantMember(tenantId); // Participant check handled at parent
         allow create: if isTenantMember(tenantId);
      }
    }

    match /policyRules/{ruleId} { allow read: if isAuthenticated(); allow write: if isSystemAdmin(); }
    match /guardianFindings/{fId} { allow read, create, update: if isAuthenticated(); }
    match /installedPacks/{pId} { allow read, write: if isAuthenticated(); }

    // --- Default Deny ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
