rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isSystemAdmin() {
      let role = getUserData().role;
      return isAuthenticated() && (role == 'SuperAdmin' || role == 'Admin' || role == 'admin');
    }

    function isTenantMember(tenantId) {
      let user = getUserData();
      return isAuthenticated() && 
        (user.tenantId == tenantId || isSystemAdmin());
    }
    
    function isTenantAdmin(tenantId) {
      let role = getUserData().role;
      return isTenantMember(tenantId) && 
        (role in ['TenantAdmin', 'SchoolAdmin', 'SuperAdmin', 'Admin', 'SchoolAdministrator', 'admin']);
    }

    function isClinician(tenantId) {
       let role = getUserData().role;
       return isTenantMember(tenantId) && 
         (role in [
            'EPP', 'epp', 'EducationalPsychologist', 'educationalpsychologist', 
            'ClinicalPsychologist', 'clinicalpsychologist', 'SchoolPsychologist', 
            'TenantAdmin', 'SuperAdmin', 'Admin', 'SchoolAdministrator'
         ]);
    }

    // --- Core User Management ---
    match /users/{userId} {
      allow read: if isAuthenticated(); 
      allow write: if isSystemAdmin() || request.auth.uid == userId;
    }

    // --- Enterprise & GovIntel ---
    match /organizations/{orgId} {
      allow read: if isAuthenticated(); 
      allow create: if isSystemAdmin();
      allow update: if isSystemAdmin() || (isAuthenticated() && getUserData().tenantId == orgId && isTenantAdmin(orgId));
    }

    // --- Commercial & Billing ---
    match /tenants/{tenantId}/billing/{document=**} {
      allow read, write: if isTenantAdmin(tenantId);
    }

    // --- Student 360 Core ---
    match /tenants/{tenantId}/students/{studentId} {
      allow read: if isTenantMember(tenantId);
      allow write: if isClinician(tenantId);
      
      match /assessments/{assessmentId} {
        allow read, write: if isClinician(tenantId);
      }
      match /reports/{reportId} {
        allow read, write: if isClinician(tenantId);
      }
    }
    
    // --- Cases ---
    match /tenants/{tenantId}/cases/{caseId} {
       allow read: if isTenantMember(tenantId);
       allow write: if isClinician(tenantId);
       
       match /timeline/{eventId} {
          allow read, write: if isClinician(tenantId);
       }
    }

    // --- Consultations ---
    match /tenants/{tenantId}/consultations/{docId} {
       allow read, write: if isClinician(tenantId);
    }

    // --- Guardian ---
    match /policyRules/{ruleId} {
      allow read: if isAuthenticated();
      allow write: if isSystemAdmin();
    }

    match /guardianFindings/{findingId} {
      allow read: if isTenantMember(resource.data.tenantId);
      allow create: if isAuthenticated();
      allow update: if isTenantMember(resource.data.tenantId) && isTenantAdmin(resource.data.tenantId);
    }

    match /guardianOverrideRequests/{reqId} {
      allow read: if isTenantMember(resource.data.tenantId);
      allow create: if isTenantMember(resource.data.tenantId);
      allow update: if isTenantAdmin(resource.data.tenantId);
    }

    // --- Calendar & Appointments ---
    match /tenants/{tenantId}/appointments/{appointmentId} {
      allow read: if isTenantMember(tenantId);
      allow write: if isTenantMember(tenantId);
    }

    match /tenants/{tenantId}/availability/{slotId} {
      allow read: if isTenantMember(tenantId);
      allow write: if isAuthenticated() && (request.auth.uid == resource.data.userId || isTenantAdmin(tenantId));
    }

    // --- Internal Messaging ---
    match /tenants/{tenantId}/chats/{chatId} {
      allow read: if isTenantMember(tenantId) && request.auth.uid in resource.data.participantIds;
      allow create: if isTenantMember(tenantId);
      allow update: if isTenantMember(tenantId) && request.auth.uid in resource.data.participantIds;
      
      match /messages/{messageId} {
        allow read: if isTenantMember(tenantId) && request.auth.uid in get(/databases/$(database)/documents/tenants/$(tenantId)/chats/$(chatId)).data.participantIds;
        allow create: if isTenantMember(tenantId) && request.auth.uid == request.resource.data.senderId;
      }
    }

    // --- Community ---
    match /tenants/{tenantId}/community/{document=**} {
      allow read: if isTenantMember(tenantId);
      allow write: if isTenantMember(tenantId);
    }

    match /global/forum/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isSystemAdmin(); 
    }
    
    match /global/wiki/pages/{pageId} {
      allow read: if isAuthenticated();
      allow write: if isSystemAdmin();
    }

    // --- Default Deny ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
