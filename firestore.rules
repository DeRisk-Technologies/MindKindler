rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isSuperAdmin() {
       return request.auth.token.role == 'SuperAdmin';
    }

    // Students Collection
    // DENY direct read for students to force usage of 'getStudent360' Cloud Function
    // for sensitive data redaction.
    // ALLOW write for authorized staff only.
    match /students/{studentId} {
      allow read: if false; // Block direct reads! Use the Cloud Function.
      
      // Exception: Allow reading metadata or less sensitive index fields if needed for list views?
      // Better approach: Use a dedicated 'student_summaries' collection for list views.
      
      allow write: if isAuthenticated() && (request.auth.token.role == 'EPP' || request.auth.token.role == 'SchoolAdmin');
      
      // Subcollections
      match /family_members/{memberId} {
        allow read: if false; // Force Cloud Function
        allow write: if isAuthenticated();
      }
      
      match /verification_tasks/{taskId} {
         allow read, write: if isAuthenticated();
      }
    }

    // Document Staging
    match /document_staging/{docId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated() && resource.data.tenantId == request.auth.token.tenantId;
      allow update: if isAuthenticated(); // Refine to owner
    }

    // ... other rules
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
